extends org
block issues
  .gridbox.gridmain
    ul(id="issues")
      li.postIssuePart(id="addOrg" style="transition:0.2s all ease-in-out")
        form(method='POST', id="addMyOrg", action="/makeAnnouncement" enctype="multipart/form-data")    
          .issuePart1D(style="display:inline-block;width:100%;padding-left:13px")
            div(style="float:left")
              h(style="font-weight:500;font-size:14pt") Make Announcement
            div(style="float:right")
              i(class="glyphicon glyphicon-plus" id="expandMakeOrg")      

          .main.issueBlock
            #nextBtn(style="display:block")
              div(style="margin-left:5px")
                  input(type='text' id="issueDescriptionTopic" name="announcementTopic" placeholder="Topic" required maxlength="60")
                  
                  textarea(id="issueDescriptionText" name="announcementText" placeholder="Description" required )
                  
                  div(style="display:inline-block;width:100%")
                    div(style="display:inline-flex;float:left")
                      label(for="files" style="min-width:120px;padding:10px;margin:5.33px") Upload files
                      input(id='orgAvatar' type='file' name='announcementDocs' multiple style="margin-left:-20px!important")
                    div(style="text-align:center;float:right")
                      input( value="#{orgDtl.userId}" type="hidden" name="orgUId")
                      input( value="Post" type="submit" name="issuePost" id="issuePost")
        
      li.postIssuePart(style="border-radius:3px")
        .issuePart1D(style="background-color:white;display:inline-flex;text-align:center;width:100%;padding-left:13px;border-radius:3px;padding:0px")
          if(search(username, orgDtl.admin))
            div(style="width:33.3%;padding:10px;border-right:1px solid lightgray;border-bottom:2px solid #42b72a;cursor:pointer" id="openBtn")
              button(style="background-color:unset;font-size:14pt;border:none")
                i(class="mega-octicon octicon-issue-opened" style="background-color:unset!important;color:black;font-size:14pt;color:green")
                | #{openIssues.length - aIssues.length}
                | Open           
            
            div(style="width:33.33%;padding:10px;cursor:pointer" id="closedBtn")
              button(style="background-color:unset;font-size:14pt;border:none")
                i(class="mega-octicon octicon-issue-closed" style="background-color:unset!important;color:black;font-size:14pt;color:red")
                | #{closedIssues.length}
                | Closed                 

            div(style="width:33.33%;padding:10px;border-left:1px solid lightgray;cursor:pointer" id="aBtn")
              button(style="background-color:unset;font-size:14pt;border:none")
                i(class="fa fa-user-secret" style="background-color:unset!important;color:black;font-size:14pt;color:black;padding-right:5px")
                span#aLen #{aIssues.length}
                |  Anonymous
          else
              div(style="width:50.0%;padding:10px;border-right:1px solid lightgray;border-bottom:2px solid #42b72a;cursor:pointer" id="openBtn")
                button(style="background-color:unset;font-size:14pt;border:none")
                  i(class="mega-octicon octicon-issue-opened" style="background-color:unset!important;color:black;font-size:14pt;color:green")
                  | #{openIssues.length - aIssues.length}
                  | Open           
            
              div(style="width:50.0%;padding:10px;cursor:pointer" id="closedBtn")
                button(style="background-color:unset;font-size:14pt;border:none")
                  i(class="mega-octicon octicon-issue-closed" style="background-color:unset!important;color:black;font-size:14pt;color:red")
                  | #{closedIssues.length}
                  | Closed                 


      if(search(username, orgDtl.members))      
        div#openIssues(style="display:block;")
          if (openIssues.length-aIssues.length)!=0
            for each in openIssues
              if each.anonymity=="off"
                li.issuePart(style="box-shadow: 0 2px 4px 0 #d1d5da78,0 2px 10px 0 #d1d5da78!important;border-color:#d1d5da78")
                  .issuePart1D(style="display:inline-block;width:100%;padding-left:13px")
                    div(style="float:left;display:inline-flex")
                      div(style="float:left")
                        img(src='/uploads/'+'#{each.userAvatarPath}', alt='' style="border-radius:50%;width:40px;height:40px;margin-right:10px")
                      div(style="float:right")
                        if (each.anonymity==="on")
                          span(style='font-weight:900') Anonymous
                        else if(each.anonymity==="off")
                          a(href="/profile/"+each.username id="linkProfile" style='font-weight:900;') #{each.name}
                        
                        span(style='color:gray')  
                          i.glyphicon.glyphicon-play(style="font-size:10pt")  
                          a(href="/orgs/"+each.orgUserId id="linkProfile" style='font-weight:900;')  #{each.orgname}

                        if each.edited
                         p(id="date") Edited on #{each.datePosted}
                        else
                         p(id="date") Posted on #{each.datePosted}
                           
                    
                    div(style="float:right")
                      if (each.status==="open")
                        i(class="mega-octicon octicon-issue-opened issueStatus" id=each._id)
                          span  Open
                      else
                        i(class="mega-octicon octicon-issue-closed issueStatus" id=each._id)
                          span  Closed

                  .main.issueBlock
                    #nextBtn
                      div#issueTopic(style="margin-left:10px;width:auto!important")
                        if each.supporters.length>=(0.75*orgDtl.members.length)
                          i.glyphicon.glyphicon-fire(style="color:red;margin:5px" aria-hidden='true')
                        a(href="/indpost/"+each._id style="color:black") #{each.issueTopic}
                      div#issueDesc #{each.issueDesc}
                
                  div(id="feed_details")
                    ul(id="feed_numbers" style="padding-left:15px;list-style:none;display:inline-flex;font-size:10pt;")
                      li
                        a(href="#" ) 
                          span(id="num_of_likes") #{each.supporters.length}
                          |  Supports
                      li
                        h(style="margin-right:5px;margin-left:5px") -
                      li
                        a(href="#")
                          span(id="num_of_comments") #{each.comments.length}
                          |  Comments
                   
                    .issueCommentPart
                      button(id="likeBtn" )
                        if (each.supporters.indexOf(username)==-1)
                          i(class="fa fa-thumbs-o-up" style="font-size:18px;" id="likeBtnLogo")
                          |  I Support
                        else
                          i(class="fa fa-thumbs-up" style="font-size:18px" id="likeBtnLogo")
                          |  I Support

                      button(id="commentBtn" )
                        i(class="mega-octicon octicon-comment" style="font-size:18px")
                        |  Comment
          else
            div(style="text-align:center!important;padding-top:100px")
              i(class="mega-octicon octicon-issue-opened" style="background-color:unset!important;color:lightgray;font-size:100px;")
              br
              br
              h(style="font-weight:500; font-size:25pt; color:grey") No open issues    
            
        div#aIssues(style="display:none;")
          if aIssues.length!=0
            for each in aIssues  
              li.issuePart(style="box-shadow: 0 2px 4px 0 #d1d5da78,0 2px 10px 0 #d1d5da78!important;border-color:#d1d5da78")
                .issuePart1D(style="display:inline-block;width:100%;padding-left:13px")
                  div(style="float:left;display:inline-flex")
                    div(style="float:left")
                      img(src='/uploads/'+'#{each.userAvatarPath}', alt='' style="border-radius:50%;width:40px;height:40px;margin-right:10px")
                    div(style="float:right")
                      a(href="/profile/"+each.username id="linkProfile" style='font-weight:900;') #{each.name}
                      
                      span(style='color:gray')  
                        i.glyphicon.glyphicon-play(style="font-size:10pt")  
                        a(href="/orgs/"+each.orgUserId id="linkProfile" style='font-weight:900;')  #{each.orgname}

                      if each.edited
                       p(id="date") Edited on #{each.datePosted}
                      else
                       p(id="date") Posted on #{each.datePosted}
                    
                  
                  div(style="float:right")
                    if (each.status==="open")
                      i(class="mega-octicon octicon-issue-opened issueStatus" id=each._id)
                        span  Open
                    else
                      i(class="mega-octicon octicon-issue-closed issueStatus" id=each._id)
                        span  Closed
                    
                    .dropdown(style="width:auto!important;float:right")
                        button#menu1.dropdown-toggle(type='button', data-toggle='dropdown' style="border:none;background-color:unset")
                          i(class="ionicons ion-android-more-vertical" style="font-weight:500;font-size:20pt;margin-left:5px")
                        
                        ul.dropdown-menu(role='menu', aria-labelledby='menu1' style="font-size:12pt;font-weight:500;")
                          li(role='presentation' style="padding:5px;margin-bottom:2px")
                            button(type="submit" style="border:none;background-color:unset;margin-left:10px" role='menuitem', tabindex='-1', id="delIssueOptionBtn") Delete Issue
                            
                .main.issueBlock
                  #nextBtn
                    div#issueTopic(style="margin-left:10px;width:auto!important")
                      if each.supporters.length>=(0.75*orgDtl.members.length)
                        i.glyphicon.glyphicon-fire(style="color:red;margin:5px" aria-hidden='true')
                      a(href="/indpost/"+each._id style="color:black") #{each.issueTopic}
                    div#issueDesc #{each.issueDesc}
              
                div(id="feed_details")
                  ul(id="feed_numbers" style="padding-left:15px;list-style:none;display:inline-flex;font-size:10pt;")
                    li
                      a(href="#" ) 
                        span(id="num_of_likes") #{each.supporters.length}
                        |  Supports
                    li
                      h(style="margin-right:5px;margin-left:5px") -
                    li
                      a(href="#")
                        span(id="num_of_comments") #{each.comments.length}
                        |  Comments
                 
                  .issueCommentPart
                    button(id="likeBtn" )
                      if (each.supporters.indexOf(username)==-1)
                        i(class="fa fa-thumbs-o-up" style="font-size:18px;" id="likeBtnLogo")
                        |  I Support
                      else
                        i(class="fa fa-thumbs-up" style="font-size:18px" id="likeBtnLogo")
                        |  I Support

                    button(id="commentBtn" )
                      i(class="mega-octicon octicon-comment" style="font-size:18px")
                      |  Comment
          else
            div(style="text-align:center!important;padding-top:100px")
              i(class="fa fa-user-secret" style="background-color:unset!important;color:lightgray;font-size:100px;")
              br
              br
              h(style="font-weight:500; font-size:25pt; color:grey") No Anonymous issues

        div#closedIssues(style="display:none")
          if closedIssues.length!=0
            for each in closedIssues
              if each.anonymity=="off"  
                li.issuePart(style="box-shadow: 0 2px 4px 0 #d1d5da78,0 2px 10px 0 #d1d5da78!important;border-color:#d1d5da78")
                  .issuePart1D(style="display:inline-block;width:100%;padding-left:13px")
                    div(style="float:left;display:inline-flex")
                      div(style="float:left")
                        img(src='/uploads/'+'#{each.userAvatarPath}', alt='' style="border-radius:50%;width:40px;height:40px;margin-right:10px")
                      div(style="float:right")
                        if (each.anonymity==="on")
                          span(style='font-weight:900') Anonymous
                        else if(each.anonymity==="off")
                          a(href="/profile/"+each.username id="linkProfile" style='font-weight:900;') #{each.name}
                        
                        span(style='color:gray')  
                          i.glyphicon.glyphicon-play(style="font-size:10pt")  
                          a(href="/orgs/"+each.orgUserId id="linkProfile" style='font-weight:900;')  #{each.orgname}

                        if each.edited
                         p(id="date") Edited on #{each.datePosted}
                        else
                         p(id="date") Posted on #{each.datePosted}
                           
                    
                    div(style="float:right")
                      if (each.status==="open")
                        i(class="mega-octicon octicon-issue-opened issueStatus" id=each._id)
                          span  Open
                      else
                        i(class="mega-octicon octicon-issue-closed issueStatus" id=each._id)
                          span  Closed
                      
                  .main.issueBlock
                    #nextBtn
                      div#issueTopic(style="margin-left:10px;width:auto!important")
                        if each.supporters.length>=(0.75*orgDtl.members.length)
                          i.glyphicon.glyphicon-fire(style="color:red;margin:5px" aria-hidden='true')
                        a(href="/indpost/"+each._id style="color:black") #{each.issueTopic}
                      div#issueDesc #{each.issueDesc}
                
                  div(id="feed_details")
                    ul(id="feed_numbers" style="padding-left:15px;list-style:none;display:inline-flex;font-size:10pt;")
                      li
                        a(href="#" ) 
                          span(id="num_of_likes") #{each.supporters.length}
                          |  Supports
                      li
                        h(style="margin-right:5px;margin-left:5px") -
                      li
                        a(href="#")
                          span(id="num_of_comments") #{each.comments.length}
                          |  Comments
                   
                    .issueCommentPart
                      button(id="likeBtn" )
                        if (each.supporters.indexOf(username)==-1)
                          i(class="fa fa-thumbs-o-up" style="font-size:18px;" id="likeBtnLogo")
                          |  I Support
                        else
                          i(class="fa fa-thumbs-up" style="font-size:18px" id="likeBtnLogo")
                          |  I Support

                      button(id="commentBtn" )
                        i(class="mega-octicon octicon-comment" style="font-size:18px")
                        |  Comment
          else
            div(style="text-align:center!important;padding-top:100px")
              i(class="mega-octicon octicon-issue-closed" style="background-color:unset!important;color:lightgray;font-size:100px;")
              br
              br
              h(style="font-weight:500; font-size:25pt; color:grey") No closed issues    

      else
        div(style="text-align:center!important;padding-top:100px")
            img(src="/images/SuccessLogo.png" style="width:30%;opacity:0.7")
            br
            br
            h(style="font-weight:500; font-size:25pt; color:grey") You'r not a member yet

  script.
     
      $('#expandMakeOrg').click(function(){
        $('#nextBtn').slideToggle();
        $(this).toggleClass('glyphicon-plus glyphicon-minus');
      });
      $('li.postIssuePart#addOrg').mouseover(function(){
        $(this).css({
          'box-shadow': '0 20px 60px 0 rgba(27,42,53,.25)',
          'transform': 'translateY(-1%)'
        })
      })

      $('li.postIssuePart#addOrg').mouseout(function(){
        $(this).css({
          'transform': 'translateY(1%)',
          'box-shadow' : '0 2px 4px 0 #d4e8ff,0 2px 10px 0 #d4e8ff'
        })
      })

      $('.main.issueBlock #issueDesc').each(function(){
        var descLength = $(this).text().length;
        var descTrimmed1 = (descLength>250)?("<span id='descTrimmed1'>"+$(this).text().substring(0,250)+"</span><span id='3dots'>...</span>"):($(this).text());
        var descTrimmed2 = (descLength>250)?("<span id='descTrimmed2' style='display:none'>"+$(this).text().substring(250)+"</span>"+"<span id='readMore' style='color:#337ab7;cursor:pointer'>Read More</span>"):"";
        
        $(this).html(descTrimmed1+descTrimmed2);
        //- (descTrimmed.length>200)?($(this).append('<span id="readMore" style="color:#337ab7;cursor:pointer">Read More</span>')):1;
        //- $('#readMore')
      });

      $('#issueDesc #readMore').click(function(){
        if($(this).text()=="Read More")
          {
            $(this).text('Read Less');
          }
        else
          $(this).text('Read More');
          $(this).siblings('#descTrimmed2').toggle();
          $(this).siblings('#3dots').toggle();
      });

      $('#expandPost').click(function(){
        $('#nextBtn').slideToggle();
        $(this).toggleClass('glyphicon-plus glyphicon-minus');
      })


      $('#openBtn').click(function(){
        $('#openIssues').show();
        $('#closedIssues').hide();
        $('#aIssues').hide();
        $(this).css({
          'border-bottom' : '2px solid #42b72a'
        })
        $('#closedBtn').css({
          'border-bottom' : '2px solid white'
        })
        $('#aBtn').css({
          'border-bottom' : '2px solid white'
        })
      });

      $('#closedBtn').click(function(){
        $('#openIssues').hide();
        $('#closedIssues').show();
        $('#aIssues').hide();
        $(this).css({
          'border-bottom' : '2px solid #42b72a'
        })
        $('#openBtn').css({
          'border-bottom' : '2px solid white'
        })
        $('#aBtn').css({
          'border-bottom' : '2px solid white'
        })
        
      });

      $('#aBtn').click(function(){
        $('#openIssues').hide();
        $('#closedIssues').hide();
        $('#aIssues').show();
        $(this).css({
          'border-bottom' : '2px solid #42b72a'
        })
        $('#openBtn').css({
          'border-bottom' : '2px solid white'
        })
        $('#closedBtn').css({
          'border-bottom' : '2px solid white'
        })
      });

      $('#expandPost').click(function(){
        $('#nextBtn').toggle();
        $(this).toggleClass('glyphicon-plus glyphicon-minus');
      })

      $('button#likeBtn').click(function(e){

        if( $(this).find('i#likeBtnLogo').hasClass("fa-thumbs-up") )
          { 
           console.log("Executed 1");
            $(this).parents('#feed_details').find('#num_of_likes').html(parseInt($(this).parents('#feed_details').find('#num_of_likes').text()[0])-1);
          }
        
        else if( $(this).find('i#likeBtnLogo').hasClass('fa-thumbs-o-up') )
          {
           console.log("Executed 2");
            $(this).parents('#feed_details').find('#num_of_likes').html(parseInt($(this).parents('#feed_details').find('#num_of_likes').text()[0])+1);
          }

          e.preventDefault();
          $(this).find('i.fa').toggleClass('fa-thumbs-o-up fa-thumbs-up');
          var id = $(this).parents('li.issuePart').find('i.issueStatus').attr('id');
          console.log(id);
          
          var _url = "/likepost/"+id;
          console.log(_url);
          $.post({
          url: _url,
        });
      });

      $('button#delIssueOptionBtn').click(function(){
        var delIssueOptionBtn = $(this);
        var id = $(delIssueOptionBtn).closest('li.issuePart').find('i.issueStatus').attr('id');
        var delPost = $(delIssueOptionBtn);

        $.ajax({
          method : 'POST',
          url : '/delpostA/'+id,
          success: function(data){
            if(data=="1")
              {
                $('li.postIssuePart .issuePart1D').find('#aLen').html(parseInt($('li.postIssuePart .issuePart1D').find('#aLen').text()-1)+" ");
                delPost.closest('li.issuePart').remove();
              }
          }
        });
      });